<% content_for :header_tags do %>
    <%= stylesheet_link_tag('application.css', :plugin => "redmine_fpt_staffs", :media => "all") %>
    <%= javascript_include_tag 'application.js',:plugin => 'redmine_fpt_staffs' %>
<% end %>

<%= title @query.new_record? ? l(:label_staff_dashboard_plural) : @query.name %>

<%= form_tag("/staffs/dashboard", :remote => true, :method => :get, :id => 'query_form') do %>
  <%= render :partial => 'staffs/query_form' %>
<% end %>

<% if @query.valid? %>
	<%= render :partial => 'staffs/dashboards/highcharts', :locals => {:time => @time, :query => @query} %>
<% end %>

<style>
	.ui-datepicker-calendar, span.ui-datepicker-month {
		display: none;
	}
</style>

<script type="text/javascript">
  $(document).ready(function(){
  	$('.block-receiver').sortable({
		connectWith: '.block-receiver',
		handle: '.sort-handle',
		update: function(event, ui){
    		$("#dashboard_employee").highcharts().reflow();
    		$("#dashboard_employee_half").highcharts().reflow();
    		$("#dashboard_employee_out").highcharts().reflow();
    		$("#dashboard_employee_in").highcharts().reflow();
    		$("#dashboard_reason_off").highcharts().reflow();
    		$("#dashboard_reason_off_year").highcharts().reflow();
		},
	    start: function(event, ui){$(this).parent().addClass('dragging');},
	    stop: function(event, ui){$(this).parent().removeClass('dragging');},
  	});

  	filter_month();
  	filter_year();
  	// $('#add_filter_select').change(function() {
	// 	filter_month();
	// 	filter_year();
	// 	toggleOperator("year");
	// });
  	function filter_month() {
  		$('#values_month').remove();
		  $('#values_month_1').addClass("date-picker");
		  $('#values_month_1').prop('type', 'text');
		  $('#values_month_1').datepicker( {
		          changeMonth: true,
		          changeYear: true,
		          showButtonPanel: true,
		          dateFormat: 'yy-mm',
		          maxDate:'Y',
		          monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          onClose: function(dateText, inst) {
		              $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
		          }
		  	});
		  $("#values_month_1").attr('readonly','readonly');
		  $("#values_month_2").attr('readonly','readonly');
		  $('#values_month_2').prop('type', 'text');
		  $('#values_month_2').addClass("date-picker");
		  $('#values_month_2').datepicker( {
		          changeMonth: true,
		          changeYear: true,
		          showButtonPanel: true,
		          dateFormat: 'yy-mm',
		          maxDate:'Y',
		          monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          onClose: function(dateText, inst) {
		              $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
		          }
		  	});
		  $('#operators_month option').each(function() {
		      if ($.inArray($(this).val(), [">t-","<t-","><t-","t-","t","ld","w","lw","l2w","m","lm","y","!*","*",">=","<="])  != -1 ) {
		          $(this).remove();
		      }
		  });
		  // load default format
		  var date_input1 = document.getElementById('values_month_1');
		  var date_input2 = document.getElementById('values_month_2');
		  if (date_input1 != null){
		    date_input1.value = changeDate(date_input1.value, 'time');
		  }
		  if (date_input2 != null){
		    date_input2.value = changeDate(date_input2.value, 'time');
		  }
  	}
      
	  function changeDate(date, option) {
	      var x = ""
	      if (date) {
			x = new Date(date);
			if (option == "year1") {
				x.setFullYear(x.getFullYear() - 1);
			}
	      }
	      else{
			x = new Date;
			if (option == "year1") {
				x.setFullYear(x.getFullYear() - 1);
			}
	      }
	      var y = x.getFullYear().toString();
	      var m = (x.getMonth() + 1).toString();
	      //var d = x.getDate().toString();
	      //(d.length == 1) && (d = '0' + d);
	      (m.length == 1) && (m = '0' + m);
	      //var yyyymmdd = y + "-" + m + "-" + "10";
	      var yyyymmdd = y + "-" + m;
	      if (option == "time") {
	      	return yyyymmdd
	      }
	      else
	      	return y;
	  }


	  function formatmonthoperator(){
	    var listoption =  ["><"];
	    var arrayLength = listoption.length;
	    for (var i = 0; i < arrayLength; i++) {
	      $("#operators_month option[value='" + listoption[i] + "']").remove();
	    }
	  }
	  function filter_year() {
	  	$('#values_year').remove();
		  $('#values_year_1').addClass("date-picker");
		  $('#values_year_1').prop('type', 'text');
		  $('#values_year_1').datepicker( {
		          changeMonth: false,
		          changeYear: true,
		          showButtonPanel: true,
		          dateFormat: 'yy',
		          maxDate:'Y',
		          monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          onClose: function(dateText, inst) {
		              $(this).datepicker('setDate', new Date(inst.selectedYear, 1, 1));
		          }
		  	});
		  $("#values_year_1").attr('readonly','readonly');
		  $("#values_year_2").attr('readonly','readonly');
		  $('#values_year_2').prop('type', 'text');
		  $('#values_year_2').addClass("date-picker");
		  $('#values_year_2').datepicker( {
		          changeMonth: false,
		          changeYear: true,
		          showButtonPanel: true,
		          dateFormat: 'yy',
		          maxDate:'Y',
		          monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"],
		          onClose: function(dateText, inst) {
		              $(this).datepicker('setDate', new Date(inst.selectedYear, 1, 1));
		          }
		  	});
		  $('#operators_year option').each(function() {
		      if ($.inArray($(this).val(), [">t-","<t-","><t-","t-","t","ld","w","lw","l2w","m","lm","y","!*","*",">=","<=", "="])  != -1 ) {
		          $(this).remove();
		      }
		  });
		  // load default format
		  var year_input1 = document.getElementById('values_year_1');
		  var year_input2 = document.getElementById('values_year_2');
		  if (year_input1 != null){
		    year_input1.value = changeDate(year_input1.value, 'year1');
		  }
		  if (year_input2 != null){
		    year_input2.value = changeDate(year_input2.value, 'year');
		  }
	  }
	});
</script>